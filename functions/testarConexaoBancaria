import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

/**
 * Testa conex√£o com banco
 * Valida credenciais e obt√©m token
 */

Deno.serve(async (req) => {
    try {
        const base44 = createClientFromRequest(req);
        const user = await base44.auth.me();

        if (!user || user.role !== 'admin') {
            return Response.json({ error: 'Unauthorized' }, { status: 401 });
        }

        const { integracao_id } = await req.json();

        if (!integracao_id) {
            return Response.json({ error: 'integracao_id √© obrigat√≥rio' }, { status: 400 });
        }

        const integracao = await base44.asServiceRole.entities.IntegracaoBancaria.get(integracao_id);

        if (!integracao) {
            return Response.json({ error: 'Integra√ß√£o n√£o encontrada' }, { status: 400 });
        }

        console.log(`üß™ Testando conex√£o: ${integracao.banco}`);

        // Se for CNAB, apenas validar campos
        if (integracao.tipo_integracao === 'arquivo_remessa') {
            const camposObrigatorios = ['agencia', 'conta', 'carteira', 'beneficiario_nome', 'beneficiario_cpf_cnpj'];
            const camposFaltando = camposObrigatorios.filter(campo => !integracao[campo]);

            if (camposFaltando.length > 0) {
                await base44.asServiceRole.entities.IntegracaoBancaria.update(integracao_id, {
                    status_conexao: 'erro',
                    mensagem_erro: `Campos obrigat√≥rios faltando: ${camposFaltando.join(', ')}`,
                });

                return Response.json({ 
                    success: false,
                    error: `Campos obrigat√≥rios faltando: ${camposFaltando.join(', ')}` 
                }, { status: 400 });
            }

            await base44.asServiceRole.entities.IntegracaoBancaria.update(integracao_id, {
                status_conexao: 'sucesso',
                mensagem_erro: null,
                ultima_sincronizacao: new Date().toISOString(),
            });

            return Response.json({
                success: true,
                message: 'Configura√ß√£o CNAB v√°lida',
                tipo: 'cnab',
            });
        }

        // Para API, testar gerando token
        const funcaoBanco = {
            bradesco: 'bancoBradescoAPI',
            itau: 'bancoItauAPI',
            santander: 'bancoSantanderAPI',
            banco_brasil: 'bancoBrasilAPI',
            caixa: 'bancoCaixaAPI',
            sicoob: 'bancoSicoobAPI',
            sicredi: 'bancoSicrediAPI',
        }[integracao.banco];

        if (!funcaoBanco) {
            return Response.json({ 
                success: false,
                error: `API n√£o implementada para ${integracao.banco}` 
            }, { status: 400 });
        }

        console.log(`üîê Testando token via ${funcaoBanco}...`);

        const response = await base44.asServiceRole.functions.invoke(funcaoBanco, {
            action: 'gerarToken',
            integracao_id,
        });

        if (response.data?.success) {
            await base44.asServiceRole.entities.IntegracaoBancaria.update(integracao_id, {
                status_conexao: 'sucesso',
                mensagem_erro: null,
                ultima_sincronizacao: new Date().toISOString(),
            });

            console.log('‚úÖ Conex√£o validada com sucesso');

            return Response.json({
                success: true,
                message: 'Conex√£o com banco estabelecida com sucesso',
                banco: integracao.banco,
                token_expires_in: response.data.expires_in,
            });
        } else {
            throw new Error(response.data?.error || 'Erro ao validar credenciais');
        }

    } catch (error) {
        console.error('‚ùå Erro ao testar conex√£o:', error);

        // Atualizar status de erro
        try {
            const base44 = createClientFromRequest(req);
            const { integracao_id } = await req.json();
            
            await base44.asServiceRole.entities.IntegracaoBancaria.update(integracao_id, {
                status_conexao: 'erro',
                mensagem_erro: error.message,
            });
        } catch {}

        return Response.json({ 
            success: false,
            error: error.message 
        }, { status: 500 });
    }
});