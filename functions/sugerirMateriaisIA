import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

Deno.serve(async (req) => {
    try {
        const base44 = createClientFromRequest(req);
        const user = await base44.auth.me();

        if (!user) {
            return Response.json({ error: 'Unauthorized' }, { status: 401 });
        }

        const { etapa, padrao, estado, area, detalhamento_projeto } = await req.json();

        console.log('üì• Par√¢metros recebidos:', { etapa, padrao, estado, area, tem_detalhamento: !!detalhamento_projeto });

        const det = detalhamento_projeto || {};
        const totalQuartos = (det.quartos_terreo || 0) + (det.suites_terreo || 0) + (det.quartos_superior || 0) + (det.suites_superior || 0);
        const totalSuites = (det.suites_terreo || 0) + (det.suites_superior || 0);
        const totalBanheiros = (det.banheiros_sociais || 0) + totalSuites + (det.lavabo ? 1 : 0);

        const etapasNomes = {
            terreno_preparacao: 'Prepara√ß√£o do Terreno',
            fundacao: 'Funda√ß√£o',
            estrutura: 'Estrutura',
            impermeabilizacao: 'Impermeabiliza√ß√£o',
            alvenaria: 'Alvenaria',
            cobertura: 'Cobertura e Telhado',
            instalacoes_eletricas: 'Instala√ß√µes El√©tricas',
            instalacoes_hidraulicas: 'Instala√ß√µes Hidr√°ulicas',
            instalacoes_gas: 'Instala√ß√µes de G√°s',
            aquecimento_solar: 'Aquecimento Solar',
            energia_solar: 'Energia Solar Fotovoltaica',
            ar_condicionado: 'Ar Condicionado',
            revestimentos: 'Revestimentos (azulejos, cer√¢micas)',
            pintura: 'Pintura',
            esquadrias: 'Esquadrias (portas e janelas)',
            pisos: 'Pisos',
            forros: 'Forros',
            acabamento: 'Acabamento Geral',
            louca_metais: 'Lou√ßas e Metais',
            mobilia: 'Mob√≠lia',
            automacao: 'Automa√ß√£o Residencial',
            seguranca: 'Sistema de Seguran√ßa',
            wifi_dados: 'Rede WiFi e Dados',
            paisagismo: 'Paisagismo',
            limpeza_final: 'Limpeza Final',
        };

        const padraoDescricao = {
            medio_baixo: 'Econ√¥mico - materiais funcionais de qualidade aceit√°vel, marcas nacionais b√°sicas',
            medio: 'M√©dio - materiais de boa qualidade, marcas conhecidas (Portinari, Quartzolit, Tigre)',
            alto: 'Alto - materiais premium, marcas de primeira linha (Portobello, Ceusa, Deca Premium)',
            luxo: 'Luxo - materiais de alt√≠ssima qualidade, importados, marcas de luxo (Roca, Hansgrohe, Eliane Premium)'
        };

        const prompt = `Voc√™ √© um especialista em materiais de constru√ß√£o civil no Brasil com 20 anos de experi√™ncia.

üéØ TAREFA: Sugerir os 10 MELHORES materiais para "${etapasNomes[etapa]}" em padr√£o "${padrao.toUpperCase()}".

üìã DESCRI√á√ÉO DO PADR√ÉO: ${padraoDescricao[padrao]}

üè† PROJETO:
- √Årea: ${area}m¬≤
- ${totalQuartos} quartos (${totalSuites} su√≠tes)
- ${totalBanheiros} banheiros
- √Årea Gourmet: ${det.area_gourmet ? 'SIM' : 'N√ÉO'}
- Piscina: ${det.piscina ? `SIM (${det.piscina_tipo}, ${det.piscina_tamanho_m2}m¬≤)` : 'N√ÉO'}
- Garagem: ${(det.garagem_vagas || 0) + (det.subsolo_garagem_vagas || 0)} vagas

‚ö†Ô∏è REGRAS BRASIL (CR√çTICO):
1. Quantidades SEMPRE INTEIRAS (m¬≤, m¬≥, di√°rias, horas, sacos, unidades)
2. N√ÉO retornar 2.5m¬≤, 1.7 di√°rias, 3.4m¬≥
3. Arredondar para CIMA (teto)
4. Produtos REAIS vendidos no Brasil
5. Marcas ESPEC√çFICAS (n√£o gen√©ricos)
6. Pre√ßos de ${estado} em 2024/2025

üìå EXEMPLOS CORRETOS:

**FUNDA√á√ÉO (padr√£o m√©dio):**
- Cimento CP-II-E-32 Votoran 50kg ‚Üí R$ 32,00/saco ‚Üí 45 sacos
- Areia m√©dia lavada ‚Üí R$ 120,00/m¬≥ ‚Üí 8m¬≥
- Brita n¬∫ 1 ‚Üí R$ 110,00/m¬≥ ‚Üí 6m¬≥

**PINTURA (padr√£o alto):**
- Tinta Acr√≠lica Premium Suvinil Branco 18L ‚Üí R$ 210,00/lata ‚Üí 12 latas
- Massa Acr√≠lica Suvinil 25kg ‚Üí R$ 58,00/saco ‚Üí 8 sacos

**REVESTIMENTOS (padr√£o luxo):**
- Porcelanato Portobello Calacata Exclusive 90x90cm ‚Üí R$ 145,00/m¬≤ ‚Üí 180m¬≤
- Argamassa ACIII Quartzolit 20kg ‚Üí R$ 38,00/saco ‚Üí 25 sacos

**INSTALA√á√ïES EL√âTRICAS:**
- Disjuntor 32A Siemens ‚Üí R$ 28,50/unidade ‚Üí ${Math.ceil(totalQuartos * 1.5)} unidades
- Fio 2.5mm¬≤ Pirelli ‚Üí R$ 280,00/rolo ‚Üí 8 rolos

**M√ÉO DE OBRA:**
- Pedreiro profissional ‚Üí R$ 280,00/di√°ria ‚Üí 45 di√°rias
- Servente ‚Üí R$ 150,00/di√°ria ‚Üí 45 di√°rias

üéØ PARA ESTA ETAPA ESPEC√çFICA (${etapasNomes[etapa]}):
Sugira produtos/servi√ßos ESSENCIAIS, com marca, especifica√ß√£o t√©cnica completa, pre√ßo real de ${estado} e quantidade INTEIRA calculada para ${area}m¬≤.

Retorne JSON:`;

        console.log('ü§ñ Chamando IA...');

        const response = await base44.integrations.Core.InvokeLLM({
            prompt: prompt,
            add_context_from_internet: true,
            response_json_schema: {
                type: "object",
                properties: {
                    materiais: {
                        type: "array",
                        items: {
                            type: "object",
                            properties: {
                                nome: { type: "string" },
                                categoria: {
                                    type: "string",
                                    enum: ["material", "mao_de_obra", "equipamento", "servico", "moveis", "eletrodomesticos"]
                                },
                                especificacao: { type: "string" },
                                unidade_medida: {
                                    type: "string",
                                    enum: ["m2", "m3", "m", "kg", "saco", "unidade", "conjunto", "servico", "hora", "diaria", "litro", "balde", "lata", "galao", "rolo", "barra", "caixa"]
                                },
                                quantidade_por_m2: { type: "number" },
                                quantidade_total: { type: "number" },
                                valor_unitario_atual: { type: "number" },
                                marca_sugerida: { type: "string" },
                                fornecedor_sugerido: { type: "string" },
                                justificativa: { type: "string" },
                                rendimento: { type: "string" },
                                norma_tecnica: { type: "string" }
                            }
                        }
                    },
                    observacoes_gerais: { type: "string" }
                }
            }
        });

        console.log('‚úÖ Resposta da IA:', response);

        if (!response || !response.materiais || !Array.isArray(response.materiais) || response.materiais.length === 0) {
            console.log('‚ö†Ô∏è IA retornou vazio ou inv√°lido');
            return Response.json({
                success: false,
                message: `IA n√£o retornou sugest√µes para "${etapasNomes[etapa]}". Tente outra etapa ou adicione itens manualmente.`,
                data: { materiais: [], observacoes: 'Nenhuma sugest√£o dispon√≠vel' }
            });
        }

        const materiaisProcessados = response.materiais.map(mat => {
            const unidadesInteiras = ['unidade', 'conjunto', 'saco', 'balde', 'lata', 'galao', 'rolo', 'barra', 'caixa', 'm2', 'm3', 'diaria', 'hora', 'servico'];
            let qtdTotal = mat.quantidade_total || (mat.quantidade_por_m2 * area);

            if (unidadesInteiras.includes(mat.unidade_medida)) {
                qtdTotal = Math.ceil(qtdTotal);
            }

            return {
                ...mat,
                quantidade_total: qtdTotal
            };
        });

        console.log(`‚úÖ ${materiaisProcessados.length} materiais processados`);

        return Response.json({
            success: true,
            data: {
                materiais: materiaisProcessados,
                observacoes: response.observacoes_gerais || `${materiaisProcessados.length} materiais sugeridos para ${etapasNomes[etapa]}`
            }
        });

    } catch (error) {
        console.error('‚ùå Erro ao sugerir materiais:', error);
        return Response.json({
            success: false,
            error: error.message,
            message: `Erro ao processar: ${error.message}`,
            data: { materiais: [], observacoes: 'Erro ao buscar sugest√µes' }
        }, { status: 500 });
    }
});