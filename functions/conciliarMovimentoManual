import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

/**
 * Concilia manualmente um movimento banc√°rio com um boleto
 * Usado quando h√° sugest√µes de match para revis√£o manual
 */

Deno.serve(async (req) => {
    try {
        const base44 = createClientFromRequest(req);
        const user = await base44.auth.me();

        if (!user || user.role !== 'admin') {
            return Response.json({ error: 'Unauthorized' }, { status: 401 });
        }

        const { conciliacao_id, movimento_index, boleto_id, caixa_id } = await req.json();

        if (!conciliacao_id || movimento_index === undefined || !boleto_id) {
            return Response.json({ 
                error: 'conciliacao_id, movimento_index e boleto_id s√£o obrigat√≥rios' 
            }, { status: 400 });
        }

        console.log(`üîó Conciliando manualmente movimento ${movimento_index} com boleto ${boleto_id}`);

        // Buscar concilia√ß√£o
        const conciliacao = await base44.asServiceRole.entities.ConciliacaoBancaria.get(conciliacao_id);
        
        if (!conciliacao) {
            return Response.json({ error: 'Concilia√ß√£o n√£o encontrada' }, { status: 400 });
        }

        // Buscar boleto
        const boleto = await base44.asServiceRole.entities.Boleto.get(boleto_id);
        
        if (!boleto) {
            return Response.json({ error: 'Boleto n√£o encontrado' }, { status: 400 });
        }

        // Atualizar movimento na concilia√ß√£o
        const movimentos = [...conciliacao.movimentos];
        const movimento = movimentos[movimento_index];

        if (!movimento) {
            return Response.json({ error: 'Movimento n√£o encontrado' }, { status: 400 });
        }

        // Criar movimenta√ß√£o de caixa
        const movCaixa = await base44.asServiceRole.entities.MovimentacaoCaixa.create({
            caixa_id: caixa_id || conciliacao.caixa_id,
            tipo: movimento.tipo === 'credito' ? 'entrada' : 'saida',
            categoria: 'recebimento_cliente',
            valor: movimento.valor,
            data_movimentacao: movimento.data_movimento,
            descricao: `Concilia√ß√£o manual - ${boleto.sacado_nome}`,
            automatico: false,
        });

        // Atualizar boleto
        const valorJaPago = boleto.valor_pago_parcial || 0;
        const valorTotal = valorJaPago + movimento.valor;
        const isPagamentoParcial = valorTotal < boleto.valor_nominal;

        const historicoAtual = boleto.historico_pagamentos || [];
        historicoAtual.push({
            data_pagamento: movimento.data_movimento,
            valor_pago: movimento.valor,
            forma_pagamento: 'boleto',
            origem: 'conciliacao',
            conciliacao_id,
            movimentacao_caixa_id: movCaixa.id,
            observacoes: `Concilia√ß√£o manual - ${movimento.descricao}`,
            registrado_por: user.email,
            data_registro: new Date().toISOString(),
        });

        await base44.asServiceRole.entities.Boleto.update(boleto_id, {
            status: isPagamentoParcial ? 'pago_parcial' : 'pago',
            valor_pago_parcial: valorTotal,
            valor_pago: isPagamentoParcial ? null : valorTotal,
            data_pagamento: isPagamentoParcial ? null : movimento.data_movimento,
            historico_pagamentos: historicoAtual,
            processado_retorno: true,
            data_processamento_retorno: new Date().toISOString(),
        });

        // Atualizar movimento
        movimento.status_conciliacao = 'conciliado';
        movimento.boleto_id = boleto_id;
        movimento.movimentacao_caixa_id = movCaixa.id;
        movimento.conciliado_manualmente = true;
        movimento.conciliado_por = user.email;
        movimento.data_conciliacao = new Date().toISOString();
        movimento.score_match = 100;

        movimentos[movimento_index] = movimento;

        // Atualizar concilia√ß√£o
        const novosQuantitativos = {
            quantidade_conciliados: conciliacao.quantidade_conciliados + 1,
            quantidade_pendentes: Math.max(0, conciliacao.quantidade_pendentes - 1),
            movimentos,
        };

        if (novosQuantitativos.quantidade_pendentes === 0 && conciliacao.quantidade_divergencias === 0) {
            novosQuantitativos.status = 'concluido';
        }

        await base44.asServiceRole.entities.ConciliacaoBancaria.update(conciliacao_id, novosQuantitativos);

        console.log('‚úÖ Concilia√ß√£o manual realizada com sucesso');

        return Response.json({
            success: true,
            message: 'Movimento conciliado com sucesso',
            boleto_atualizado: boleto_id,
            status_boleto: isPagamentoParcial ? 'pago_parcial' : 'pago',
        });

    } catch (error) {
        console.error('‚ùå Erro na concilia√ß√£o manual:', error);
        return Response.json({ error: error.message }, { status: 500 });
    }
});