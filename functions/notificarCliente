import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

Deno.serve(async (req) => {
  try {
    const base44 = createClientFromRequest(req);
    
    // Verificar autentica√ß√£o (apenas admins podem criar notifica√ß√µes)
    const user = await base44.auth.me();
    if (!user || user.role !== 'admin') {
      return Response.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const { 
      cliente_id, 
      tipo, 
      titulo, 
      mensagem, 
      link, 
      referencia_id,
      referencia_tipo,
      prioridade = 'normal',
      enviar_email = false 
    } = await req.json();

    if (!cliente_id || !tipo || !titulo || !mensagem) {
      return Response.json({ 
        error: 'Campos obrigat√≥rios: cliente_id, tipo, titulo, mensagem' 
      }, { status: 400 });
    }

    // Buscar dados do cliente
    const cliente = await base44.asServiceRole.entities.Cliente.filter({ id: cliente_id });
    if (!cliente || cliente.length === 0) {
      return Response.json({ error: 'Cliente n√£o encontrado' }, { status: 404 });
    }

    const clienteData = cliente[0];

    // Criar notifica√ß√£o
    const notificacao = await base44.asServiceRole.entities.Notificacao.create({
      cliente_id,
      tipo,
      titulo,
      mensagem,
      link,
      referencia_id,
      referencia_tipo,
      prioridade,
      lida: false,
    });

    // Enviar email se solicitado ou se for cr√≠tico
    if (enviar_email || prioridade === 'critica') {
      try {
        const emailBody = `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <div style="background: linear-gradient(135deg, #922B3E 0%, #7D5999 100%); padding: 30px; text-align: center;">
              <h1 style="color: white; margin: 0;">Riviera Igua√ßu Incorporadora</h1>
              <p style="color: white; margin: 10px 0 0 0; opacity: 0.9;">Portal do Cliente</p>
            </div>
            
            <div style="padding: 30px; background: #f9f9f9;">
              <div style="background: white; padding: 25px; border-radius: 8px; border-left: 4px solid ${
                prioridade === 'critica' ? '#EF4444' : 
                prioridade === 'alta' ? '#F97316' : 
                prioridade === 'normal' ? '#3B82F6' : '#6B7280'
              };">
                ${prioridade === 'critica' ? '<div style="color: #DC2626; font-weight: bold; margin-bottom: 10px;">‚ö†Ô∏è URGENTE</div>' : ''}
                
                <h2 style="margin: 0 0 15px 0; color: #1F2937;">${titulo}</h2>
                <p style="color: #4B5563; line-height: 1.6; margin: 0 0 20px 0;">${mensagem}</p>
                
                ${link ? `
                  <a href="${link}" style="display: inline-block; background: linear-gradient(135deg, #922B3E 0%, #7D5999 100%); color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; font-weight: bold;">
                    Acessar Portal
                  </a>
                ` : ''}
              </div>
              
              <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px;">
                <p style="margin: 0; color: #6B7280; font-size: 14px;">
                  <strong>Ol√°, ${clienteData.nome}!</strong><br>
                  Esta √© uma notifica√ß√£o autom√°tica do Portal do Cliente Riviera Igua√ßu.
                </p>
              </div>
            </div>
            
            <div style="padding: 20px; text-align: center; background: #1F2937; color: white;">
              <p style="margin: 0; font-size: 12px; opacity: 0.8;">
                ¬© 2025 Riviera Igua√ßu Incorporadora. Todos os direitos reservados.
              </p>
              <p style="margin: 10px 0 0 0; font-size: 12px; opacity: 0.8;">
                Se voc√™ n√£o solicitou esta notifica√ß√£o, por favor ignore este email.
              </p>
            </div>
          </div>
        `;

        await base44.asServiceRole.integrations.Core.SendEmail({
          to: clienteData.email,
          subject: `${prioridade === 'critica' ? 'üö® URGENTE - ' : ''}${titulo}`,
          body: emailBody,
          from_name: 'Riviera Igua√ßu Incorporadora',
        });

        // Atualizar notifica√ß√£o indicando que email foi enviado
        await base44.asServiceRole.entities.Notificacao.update(notificacao.id, {
          email_enviado: true,
          data_envio_email: new Date().toISOString(),
        });
      } catch (emailError) {
        console.error('Erro ao enviar email:', emailError);
        // N√£o falhar a notifica√ß√£o se o email falhar
      }
    }

    return Response.json({ 
      success: true, 
      notificacao,
      email_enviado: enviar_email || prioridade === 'critica'
    });

  } catch (error) {
    console.error('Erro ao criar notifica√ß√£o:', error);
    return Response.json({ 
      error: error.message 
    }, { status: 500 });
  }
});