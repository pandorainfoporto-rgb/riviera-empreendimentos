import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

/**
 * Integra√ß√£o com API Sicoob
 */

Deno.serve(async (req) => {
    try {
        const base44 = createClientFromRequest(req);
        const user = await base44.auth.me();

        if (!user) {
            return Response.json({ error: 'Unauthorized' }, { status: 401 });
        }

        const { action, integracao_id, boleto_data } = await req.json();

        const integracao = await base44.asServiceRole.entities.IntegracaoBancaria.get(integracao_id);

        if (!integracao || integracao.banco !== 'sicoob') {
            return Response.json({ error: 'Integra√ß√£o Sicoob n√£o encontrada' }, { status: 400 });
        }

        const baseURL = integracao.ambiente === 'producao'
            ? 'https://api.sicoob.com.br'
            : 'https://sandbox.sicoob.com.br';

        // 1. GERAR TOKEN
        if (action === 'gerarToken') {
            console.log('üîê Gerando token Sicoob...');

            const tokenResponse = await fetch(`${baseURL}/oauth/token`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    grant_type: 'client_credentials',
                    client_id: integracao.client_id,
                    client_secret: integracao.client_secret,
                }),
            });

            if (!tokenResponse.ok) {
                const error = await tokenResponse.json();
                throw new Error(`Erro OAuth Sicoob: ${error.error_description}`);
            }

            const tokenData = await tokenResponse.json();

            const expiraEm = new Date();
            expiraEm.setSeconds(expiraEm.getSeconds() + tokenData.expires_in);

            await base44.asServiceRole.entities.IntegracaoBancaria.update(integracao_id, {
                token_acesso: tokenData.access_token,
                token_expiracao: expiraEm.toISOString(),
            });

            return Response.json({
                success: true,
                access_token: tokenData.access_token,
            });
        }

        // 2. REGISTRAR BOLETO
        if (action === 'registrarBoleto') {
            console.log('üìÑ Registrando boleto no Sicoob...');

            let accessToken = integracao.token_acesso;

            const proximoNosso = (integracao.numero_remessa || 1) + 1;
            const nossoNumero = String(proximoNosso).padStart(10, '0');

            const boletoRequest = {
                numeroContrato: integracao.convenio,
                modalidade: integracao.carteira,
                numeroContaCorrente: integracao.conta,
                especieDocumento: integracao.especie_documento || 'DM',
                dataEmissao: boleto_data.data_emissao || new Date().toISOString().split('T')[0],
                seuNumero: boleto_data.numero_documento || nossoNumero,
                nossoNumero: nossoNumero,
                dataVencimento: boleto_data.data_vencimento,
                valor: boleto_data.valor_nominal,
                pagador: {
                    numeroCpfCnpj: boleto_data.sacado_cpf_cnpj.replace(/\D/g, ''),
                    nome: boleto_data.sacado_nome,
                    endereco: boleto_data.sacado_endereco,
                    cidade: boleto_data.sacado_cidade,
                    uf: boleto_data.sacado_uf,
                    cep: boleto_data.sacado_cep.replace(/\D/g, ''),
                },
                juros: {
                    tipo: 'PERCENTUAL_DIA',
                    valor: boleto_data.percentual_juros_mora || integracao.juros_mora_percentual,
                },
                multa: {
                    tipo: 'PERCENTUAL',
                    valor: boleto_data.percentual_multa || integracao.multa_atraso_percentual,
                },
            };

            const registroResponse = await fetch(`${baseURL}/cobranca/v1/boletos`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`,
                },
                body: JSON.stringify(boletoRequest),
            });

            if (!registroResponse.ok) {
                const error = await registroResponse.json();
                throw new Error(`Erro registro: ${error.mensagem}`);
            }

            const boletoRegistrado = await registroResponse.json();

            await base44.asServiceRole.entities.IntegracaoBancaria.update(integracao_id, {
                numero_remessa: proximoNosso,
            });

            return Response.json({
                success: true,
                nosso_numero: boletoRegistrado.nossoNumero,
                linha_digitavel: boletoRegistrado.linhaDigitavel,
                codigo_barras: boletoRegistrado.codigoBarras,
                url_boleto: boletoRegistrado.urlBoleto,
                id_banco: boletoRegistrado.nossoNumero,
            });
        }

        return Response.json({ error: 'A√ß√£o n√£o suportada' }, { status: 400 });

    } catch (error) {
        console.error('‚ùå Erro Sicoob API:', error);
        return Response.json({ error: error.message }, { status: 500 });
    }
});