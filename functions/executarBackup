import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';
import AdmZip from 'npm:adm-zip@0.5.10';

Deno.serve(async (req) => {
    try {
        const base44 = createClientFromRequest(req);
        const user = await base44.auth.me();

        if (!user || user.role !== 'admin') {
            return Response.json({ error: 'Unauthorized' }, { status: 401 });
        }

        const { configuracao_id } = await req.json();

        if (!configuracao_id) {
            return Response.json({ 
                error: 'Configura√ß√£o de backup √© obrigat√≥ria' 
            }, { status: 400 });
        }

        const dataInicio = new Date();
        
        // Criar registro de hist√≥rico
        const historico = await base44.asServiceRole.entities.HistoricoBackup.create({
            configuracao_backup_id: configuracao_id,
            tipo: 'manual',
            data_inicio: dataInicio.toISOString(),
            status: 'em_andamento',
            executado_por: user.email,
        });

        try {
            // Buscar configura√ß√£o
            const config = await base44.asServiceRole.entities.ConfiguracaoBackup.get(configuracao_id);

            // Lista de todas as entidades do sistema
            const entidadesDisponiveis = [
                'Empreendimento', 'Socio', 'Cliente', 'Fornecedor', 'Consorcio',
                'PagamentoCliente', 'PagamentoFornecedor', 'Negociacao', 'Unidade',
                'Loteamento', 'AporteSocio', 'CronogramaObra', 'CronogramaFinanceiro',
                'Banco', 'Conta', 'Corretora', 'TipoAtivo', 'Servico', 'Produto',
                'Investimento', 'Caixa', 'MovimentacaoCaixa', 'Orcamento',
                'Empresa', 'ConfiguracaoBackup', 'HistoricoBackup'
            ];

            const entidadesParaBackup = config.entidades_incluidas?.length > 0 
                ? config.entidades_incluidas 
                : entidadesDisponiveis;

            // Coletar dados de todas as entidades
            const backupData = {
                data_backup: dataInicio.toISOString(),
                app_version: '1.0.0',
                entidades: {}
            };

            const detalhes = [];
            let totalRegistros = 0;

            for (const entidade of entidadesParaBackup) {
                try {
                    const dados = await base44.asServiceRole.entities[entidade].list();
                    backupData.entidades[entidade] = dados;
                    detalhes.push({
                        entidade,
                        quantidade: dados.length
                    });
                    totalRegistros += dados.length;
                } catch (error) {
                    console.error(`Erro ao buscar ${entidade}:`, error);
                    backupData.entidades[entidade] = [];
                    detalhes.push({ entidade, quantidade: 0 });
                }
            }

            // Gerar JSON
            const jsonContent = JSON.stringify(backupData, null, 2);
            const encoder = new TextEncoder();
            const jsonBytes = encoder.encode(jsonContent);

            let finalBytes = jsonBytes;
            let nomeArquivo = `backup_riviera_${dataInicio.toISOString().split('T')[0]}.json`;

            // Compactar se configurado
            if (config.compactar) {
                const zip = new AdmZip();
                zip.addFile('backup.json', jsonBytes);
                finalBytes = zip.toBuffer();
                nomeArquivo = `backup_riviera_${dataInicio.toISOString().split('T')[0]}.zip`;
            }

            // Salvar arquivo localmente (tempor√°rio)
            const caminhoTemp = `/tmp/${nomeArquivo}`;
            await Deno.writeFile(caminhoTemp, finalBytes);

            const tamanhoBytes = finalBytes.length;
            const tamanhoMB = (tamanhoBytes / (1024 * 1024)).toFixed(2);

            let arquivoNuvem = caminhoTemp;

            // Upload para nuvem (implementa√ß√£o simplificada)
            if (config.plataforma === 'google_drive') {
                // Aqui voc√™ implementaria o upload real para Google Drive
                arquivoNuvem = `google_drive://${nomeArquivo}`;
            } else if (config.plataforma === 'onedrive') {
                arquivoNuvem = `onedrive://${nomeArquivo}`;
            } else if (config.plataforma === 'mega') {
                arquivoNuvem = `mega://${nomeArquivo}`;
            }

            const dataConclusao = new Date();
            const duracaoSegundos = Math.round((dataConclusao - dataInicio) / 1000);

            // Atualizar hist√≥rico
            await base44.asServiceRole.entities.HistoricoBackup.update(historico.id, {
                data_conclusao: dataConclusao.toISOString(),
                duracao_segundos: duracaoSegundos,
                status: 'concluido',
                tamanho_bytes: tamanhoBytes,
                tamanho_formatado: `${tamanhoMB} MB`,
                arquivo_local: caminhoTemp,
                arquivo_nuvem: arquivoNuvem,
                quantidade_registros: totalRegistros,
                entidades_incluidas: entidadesParaBackup,
                detalhes_entidades: detalhes,
            });

            // Atualizar configura√ß√£o
            await base44.asServiceRole.entities.ConfiguracaoBackup.update(configuracao_id, {
                ultimo_backup: dataConclusao.toISOString(),
                status: 'ativo',
            });

            // Enviar notifica√ß√£o se configurado
            if (config.notificar_conclusao && config.emails_notificacao?.length > 0) {
                for (const email of config.emails_notificacao) {
                    try {
                        await base44.asServiceRole.integrations.Core.SendEmail({
                            from_name: 'Sistema Riviera - Backup',
                            to: email,
                            subject: '‚úÖ Backup Conclu√≠do com Sucesso',
                            body: `
Backup executado com sucesso!

üìä INFORMA√á√ïES DO BACKUP:
- Configura√ß√£o: ${config.nome_configuracao}
- Data/Hora: ${dataConclusao.toLocaleString('pt-BR')}
- Tamanho: ${tamanhoMB} MB
- Registros: ${totalRegistros}
- Dura√ß√£o: ${duracaoSegundos}s
- Plataforma: ${plataformas.find(p => p.value === config.plataforma)?.label}

‚úÖ Seus dados est√£o seguros!

Equipe Riviera
                            `.trim()
                        });
                    } catch (emailError) {
                        console.error('Erro ao enviar notifica√ß√£o:', emailError);
                    }
                }
            }

            return Response.json({ 
                success: true,
                message: `Backup conclu√≠do! ${totalRegistros} registros (${tamanhoMB} MB)`,
                tamanho_mb: tamanhoMB,
                total_registros: totalRegistros,
                duracao_segundos: duracaoSegundos,
            });

        } catch (error) {
            // Atualizar hist√≥rico com erro
            await base44.asServiceRole.entities.HistoricoBackup.update(historico.id, {
                status: 'erro',
                data_conclusao: new Date().toISOString(),
                erro_mensagem: error.message,
            });

            throw error;
        }

    } catch (error) {
        console.error('Erro ao executar backup:', error);
        return Response.json({ 
            success: false,
            error: error.message || 'Erro ao executar backup' 
        }, { status: 500 });
    }
});